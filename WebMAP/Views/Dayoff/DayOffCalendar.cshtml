@model WebMAP.Models.ResourceVM

@{
    ViewBag.Title = "DayOffCalendar";
    Layout = "~/Views/Shared/_Layout.cshtml";
    List<WebMAP.Models.leavetypeVM> leaves = ViewBag.LeaveTypes;
}


<div class="row">
    <div class="col-lg-3">

        <!--begin::Portlet-->
        <div class="m-portlet" id="m_portlet">
            <div class="m-portlet__head">
                <div class="m-portlet__head-caption">
                    <div class="m-portlet__head-title">
                        <span class="m-portlet__head-icon">
                            <i class="flaticon-add"></i>
                        </span>
                        <h3 class="m-portlet__head-text">
                            Leave Types
                        </h3>
                    </div>
                </div>
            </div>
            <div class="m-portlet__body">
                <div id="m_calendar_external_events" class="fc-unthemed">

                    @foreach (var item in leaves)
                    {
                        <div class='fc-event fc-event-external fc-start m-fc-event--primary m--margin-bottom-15' data-color="m-fc-event--primary" data-idleavetype="@item.idLeaveType" data-desc="@item.description">
                            <div class="fc-title">
                                <div class="fc-content">@item.name</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!--end::Portlet-->
    </div>
    <div class="col-lg-9">

        <!--begin::Portlet-->
        <div class="m-portlet" id="m_portlet">
            <div class="m-portlet__head">
                <div class="m-portlet__head-caption">
                    <div class="m-portlet__head-title">
                        <span class="m-portlet__head-icon">
                            <i class="flaticon-calendar-2"></i>
                        </span>
                        <h3 class="m-portlet__head-text">
                            My Calendar
                        </h3>
                    </div>
                </div>

            </div>
            <div class="m-portlet__body">
                <div id="m_calendara"></div>
            </div>
        </div>

        <!--end::Portlet-->
    </div>
</div>
@section Scripts2{
<script src="~/Content/assets/vendors/custom/fullcalendar/fullcalendar.bundle.js" type="text/javascript"></script>
<script src="~/Content/assets/vendors/custom/jquery-ui/jquery-ui.bundle.js"></script>
<script src="~/Content/assets/demo/default/custom/crud/datatables/basic/basic.js" type="text/javascript"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        var CalendarExternalEvents = {
            init: function () {
                var e, t, i, r, a;
                $("#m_calendar_external_events .fc-event").each(function () {
                    $(this).data("event", {
                        title: $.trim($(this).text()),
                        description: $(this).data("desc"),
                        idLV: $(this).data("idleavetype"),
                        stick: !0,
                        className: $(this).data("color")
                    }), $(this).draggable({
                        zIndex: 999,
                        revert: !0,
                        revertDuration: 0
                    })
                }), e = moment().startOf("day"),
                t = e.format("YYYY-MM"),
                i = e.clone().subtract(1, "day").format("YYYY-MM-DD"),
                r = e.format("YYYY-MM-DD"),
                a = e.clone().add(1, "day").format("YYYY-MM-DD"),
                $("#m_calendara").fullCalendar({
                    timezone:"local",
                    isRTL: mUtil.isRTL(),
                    header: {
                        left: "prev,next today",
                        center: "title",
                        right: "month,agendaWeek"
                    },
                    eventLimit: !0,
                    navLinks: !0,
                    events: '/Dayoff/GetDayOff/@Model.idUser',
                    editable: true,
                    droppable: !0,
                   
                    eventDrop: function(calEvent, jsEvent, view) {
                        var ev = calEvent;
                        console.log(ev);
                        $.ajax({
                            type: "POST",
                            url: '/Dayoff/EditDayOff',
                            data: {
                                idUser: @Model.idUser,
                                idLV: ev.idLV,
                                idDayOff: ev.id,
                                start:ev.start.format(),
                                end:ev.end.format()
                            },
                            success: function (response) {
                           
                                $('#calendar').fullCalendar('updateEvent', ev);
                            },
                            failure: function (response) {
                                alert("error");
                            },
                            error: function (response) {
                                alert("error");
                            }
                        });
                        },
                    eventClick: function(calEvent, jsEvent, view) {
                        var ev = calEvent;
                        bootbox.confirm({
                            message: calEvent.title,
                            buttons: {
                                confirm: {
                                    label: 'Supprimer',
                                    className: 'btn-danger'
                                },
                                cancel: {
                                    label: 'Non',
                                    className: 'btn-success'
                                }
                            },
                            callback: function (result) {
                                //supprimer
                                if (result) {
                                    $.ajax({
                                        type: "POST",
                                        url: '/Dayoff/DeleteDayOff',
                                        data: {
                                            idDayOff: ev.id
                                        },
                                        //ici code suppression
                                        //contentType: "application/json; charset=utf-8",
                                        success: function (response) {
                                           // $("#m_calendara").fullCalendar('removeEvents',ev.id);
                                            //$('#m_calendara').fullCalendar('removeEvents' , function(ev){  
                                            //    return (ev.id == calEvent.id);
                                            //})
                                            $('#m_calendara').fullCalendar(
                                                           'removeEvents'
                                                                 [this] );
                                        },
                                        failure: function (response) {
                                            alert("error");
                                        },
                                        error: function (response) {
                                            alert("error");
                                        }
                                    });
                                }
                                    //edit
                                @*else {
                                    $.ajax({
                                        type: "POST",
                                        url: '/Dayoff/EditDayOff',
                                        data: {
                                            idUser: @Model.idUser,
                                            idLV: ev.idLV,
                                            idDayOff: ev.id,
                                            start:ev.start.format(),
                                            end:ev.end.format()
                                        },
                                        //contentType: "application/json; charset=utf-8",
                                        success: function (response) {

                                        },
                                        failure: function (response) {
                                            alert("error");
                                        },
                                        error: function (response) {
                                            alert("error");
                                        }
                                    });
                                }*@
                                console.log('This was logged in the callback: ' + result);
                            }
                        });


                    },
                    drop: function (e, t, i, r) {
                        var a = $.fullCalendar.moment(e.format());
                        a.stripTime(), a.time("08:00:00");
                        var n = $.fullCalendar.moment(e.format());
                        n.stripTime(),
                        n.time("12:00:00"),
                        $(this).data("event").start = a,
                        $(this).data("event").end = n;
                        var lvid =  $(this).data("event").idLV;
                        $.ajax({
                            type: "POST",
                            url: '/Dayoff/EditDayOff',
                            data: {
                                idUser: @Model.idUser,
                                idLV: lvid,
                                idDayOff: 0,
                                start:a.format(),
                                end:n.format()
                            },
                            //contentType: "application/json; charset=utf-8",
                            success: function (response) {

                            },
                            failure: function (response) {
                                alert("error");
                            },
                            error: function (response) {
                                alert("error");
                            }
                        });
                    },
                    eventRender: function (e, t) {
                        t.hasClass("fc-day-grid-event") ? (t.data("content", e.description), t.data("placement", "top"), mApp.initPopover(t)) : t.hasClass("fc-time-grid-event") ? t.find(".fc-title").append('<div class="fc-description">' + e.description + "</div>") : 0 !== t.find(".fc-list-item-title").lenght && t.find(".fc-list-item-title").append('<div class="fc-description">' + e.description + "</div>")
                    }
                })
            }
        };
        jQuery(document).ready(function () {
            CalendarExternalEvents.init()
        });
    </script>
}

